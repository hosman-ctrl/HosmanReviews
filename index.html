<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hosman Reviews - Telegram Web App</title>
    <!-- Telegram SDKs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://telegram.org/js/telegram-analytics.js"></script>
    <script src="https://telegram.org/js/telegram-webapps.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (keep all existing CSS styles exactly as they are) ... */
        
        /* Additional styles for analytics and debugging */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10000;
            max-width: 300px;
            display: none;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: var(--button-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Debug Panel -->
    <div class="debug-panel" id="debug-panel">
        <h4>Telegram SDK Status</h4>
        <div id="sdk-status">Checking...</div>
        <div id="analytics-status">Analytics: Checking...</div>
        <div id="user-info">User: Unknown</div>
        <div id="theme-info">Theme: Checking...</div>
    </div>
    
    <button class="debug-toggle" id="debug-toggle">
        <i class="fas fa-bug"></i>
    </button>

    <div class="container">
        <!-- Header Section with New Logo -->
        <div class="header">
            <svg class="header-logo" viewBox="0 0 640 480" xmlns="http://www.w3.org/2000/svg">
                <!-- ... (keep existing SVG code) ... -->
            </svg>
            <p>AI-Powered Movie Recommendations in Telegram</p>
        </div>

        <!-- AI Recommendations Section -->
        <div class="ai-input-section">
            <!-- ... (keep all existing HTML structure) ... -->
        </div>

        <!-- Trending Movies Section -->
        <div class="section">
            <!-- ... (keep all existing HTML structure) ... -->
        </div>

        <!-- Upcoming Movies Section -->
        <div class="section">
            <!-- ... (keep all existing HTML structure) ... -->
        </div>
    </div>

    <!-- Movie Details Modal -->
    <div id="movie-modal" class="modal">
        <!-- ... (keep existing modal structure) ... -->
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="modal info-modal">
        <!-- ... (keep existing modal structure) ... -->
    </div>

    <script>
        // Enhanced Telegram SDK Integration with Analytics
        const Telegram = window.Telegram?.WebApp;
        const TelegramAnalytics = window.TelegramAnalytics;
        const TelegramWebApps = window.TelegramWebApps;

        // API Configuration
        const TMDB_ACCESS_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI5ZTYzNzRiZTQ2ZTYxNGY2MzZkNjgxOWRiYmU1NGYyYiIsIm5iZiI6MTc2MzE4NjgxNC40MTEsInN1YiI6IjY5MTgxODdlOTUxNDNkZmE0NmEwZTU1OCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.SWHyK0g4TvYfDL825KRKKhGcV3nkzfAYVZdigor2QAk';
        const GEMINI_API_KEY = 'AIzaSyCTRuQZDxXGf-u2MY9HErtJWhQGgQ4_nhY';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const PLACEHOLDER_IMAGE = 'https://images.unsplash.com/photo-1534447677768-be436bb09401?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80';
        const WEBSITE_URL = 'https://hosman-ctrl.github.io/HosmanReviews/#';

        // Global variables
        let trendingPage = 1;
        let aiPage = 1;
        let currentCategory = '';
        let currentSearchQuery = '';
        let currentMovieForShare = null;
        let clickedCardRect = null;
        let currentYear = new Date().getFullYear();
        let selectedYear = currentYear;
        let isTelegramEnvironment = false;
        let analyticsInitialized = false;

        // Enhanced Telegram SDK Initialization
        function initTelegramApp() {
            console.log('Initializing Telegram Web App...');
            
            // Check if running in Telegram
            if (typeof Telegram !== 'undefined' && Telegram) {
                isTelegramEnvironment = true;
                updateDebugInfo('sdk-status', 'âœ… Telegram WebApp SDK Loaded');
                
                try {
                    // Initialize the app
                    Telegram.ready();
                    Telegram.expand();
                    
                    // Initialize Analytics
                    initTelegramAnalytics();
                    
                    // Apply Telegram theme
                    applyTelegramTheme();
                    
                    // Setup main button for randomization
                    setupTelegramMainButton();
                    
                    // Setup events
                    setupTelegramEvents();
                    
                    // Log user info
                    const user = Telegram.initDataUnsafe?.user;
                    if (user) {
                        console.log('Telegram User:', user);
                        updateDebugInfo('user-info', `User: ${user.first_name} (ID: ${user.id})`);
                        trackEvent('user_identified', { 
                            user_id: user.id,
                            first_name: user.first_name 
                        });
                    } else {
                        updateDebugInfo('user-info', 'User: Not available');
                    }
                    
                    // Track app launch
                    trackEvent('app_launched', {
                        platform: Telegram.platform,
                        version: Telegram.version
                    });
                    
                } catch (error) {
                    console.error('Error initializing Telegram app:', error);
                    updateDebugInfo('sdk-status', 'âŒ Telegram SDK Error: ' + error.message);
                }
            } else {
                updateDebugInfo('sdk-status', 'âŒ Not in Telegram environment');
                console.log('Running in standalone browser mode');
                
                // Initialize analytics for non-Telegram environment
                initStandaloneAnalytics();
            }
        }

        // Initialize Telegram Analytics
        function initTelegramAnalytics() {
            if (typeof TelegramAnalytics !== 'undefined' && Telegram.initData) {
                try {
                    // Initialize Telegram Analytics with initData
                    TelegramAnalytics.init(Telegram.initData);
                    analyticsInitialized = true;
                    updateDebugInfo('analytics-status', 'âœ… Analytics Initialized');
                    console.log('Telegram Analytics initialized successfully');
                } catch (error) {
                    console.error('Error initializing Telegram Analytics:', error);
                    updateDebugInfo('analytics-status', 'âŒ Analytics Error: ' + error.message);
                }
            } else {
                updateDebugInfo('analytics-status', 'âš ï¸ Analytics: No initData available');
            }
        }

        // Initialize standalone analytics for non-Telegram environment
        function initStandaloneAnalytics() {
            console.log('Initializing standalone analytics...');
            analyticsInitialized = true;
            updateDebugInfo('analytics-status', 'âœ… Standalone Analytics Ready');
        }

        // Enhanced event tracking
        function trackEvent(eventName, eventParams = {}) {
            const eventData = {
                ...eventParams,
                timestamp: new Date().toISOString(),
                environment: isTelegramEnvironment ? 'telegram' : 'standalone'
            };

            console.log(`Tracking event: ${eventName}`, eventData);

            // Telegram Analytics
            if (isTelegramEnvironment && typeof TelegramAnalytics !== 'undefined') {
                try {
                    TelegramAnalytics.trackEvent(eventName, eventParams);
                } catch (error) {
                    console.error('Telegram Analytics tracking error:', error);
                }
            }

            // Fallback: Send to your own analytics endpoint
            sendToCustomAnalytics(eventName, eventData);
        }

        // Send events to custom analytics endpoint
        function sendToCustomAnalytics(eventName, eventData) {
            // Replace with your actual analytics endpoint
            const ANALYTICS_ENDPOINT = 'https://your-analytics-endpoint.com/track';
            
            // Example implementation - you can modify this based on your analytics service
            fetch(ANALYTICS_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    event: eventName,
                    data: eventData,
                    app: 'hosman-reviews'
                })
            }).catch(error => {
                console.log('Analytics endpoint not available, event logged locally:', eventName);
            });
        }

        // Enhanced Telegram Main Button Setup
        function setupTelegramMainButton() {
            if (!Telegram.MainButton) {
                console.log('MainButton not available');
                return;
            }
            
            try {
                Telegram.MainButton.setText("ðŸŽ² Randomize")
                    .setBackgroundColor(getThemeColor('button_color', '#1976d2'))
                    .setTextColor(getThemeColor('button_text_color', '#ffffff'))
                    .show()
                    .onClick(() => {
                        trackEvent('randomize_clicked');
                        randomizeMovies();
                        provideHapticFeedback('light');
                    });
                
                console.log('Telegram MainButton configured successfully');
            } catch (error) {
                console.error('Error setting up MainButton:', error);
            }
        }

        // Get theme color with fallback
        function getThemeColor(colorKey, fallback) {
            if (Telegram.themeParams && Telegram.themeParams[colorKey]) {
                return Telegram.themeParams[colorKey];
            }
            return fallback;
        }

        // Enhanced Telegram Events Setup
        function setupTelegramEvents() {
            if (!Telegram.onEvent) {
                console.log('Telegram events not available');
                return;
            }
            
            try {
                Telegram.onEvent('themeChanged', () => {
                    trackEvent('theme_changed', { theme: Telegram.themeParams });
                    applyTelegramTheme();
                });
                
                Telegram.onEvent('viewportChanged', (eventData) => {
                    trackEvent('viewport_changed', eventData);
                    setTimeout(() => Telegram.expand(), 100);
                });
                
                Telegram.onEvent('mainButtonClicked', () => {
                    trackEvent('main_button_clicked');
                });
                
                Telegram.onEvent('backButtonClicked', () => {
                    trackEvent('back_button_clicked');
                    if (document.querySelector('.modal.show')) {
                        closeModal();
                    }
                });
                
                // Show back button when modal is open
                const originalOpenModal = window.openModal;
                window.openModal = function(...args) {
                    if (Telegram.BackButton) {
                        Telegram.BackButton.show();
                    }
                    return originalOpenModal.apply(this, args);
                };
                
                const originalCloseModal = window.closeModal;
                window.closeModal = function(...args) {
                    if (Telegram.BackButton) {
                        Telegram.BackButton.hide();
                    }
                    return originalCloseModal.apply(this, args);
                };
                
                console.log('Telegram events configured successfully');
            } catch (error) {
                console.error('Error setting up Telegram events:', error);
            }
        }

        // Enhanced theme application
        function applyTelegramTheme() {
            const themeParams = Telegram?.themeParams || {};
            const isDarkMode = themeParams.bg_color ? 
                !isLightColor(themeParams.bg_color) : 
                window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Apply dark or light theme
            if (isDarkMode) {
                document.body.classList.add('dark-theme');
                updateDebugInfo('theme-info', 'Theme: Dark ðŸŒ™');
            } else {
                document.body.classList.remove('dark-theme');
                updateDebugInfo('theme-info', 'Theme: Light â˜€ï¸');
            }
            
            // Update CSS variables based on theme
            if (themeParams.bg_color) {
                document.documentElement.style.setProperty('--bg-color', themeParams.bg_color);
            }
            if (themeParams.text_color) {
                document.documentElement.style.setProperty('--text-color', themeParams.text_color);
            }
            if (themeParams.hint_color) {
                document.documentElement.style.setProperty('--hint-color', themeParams.hint_color);
            }
            if (themeParams.link_color) {
                document.documentElement.style.setProperty('--link-color', themeParams.link_color);
            }
            if (themeParams.button_color) {
                document.documentElement.style.setProperty('--button-color', themeParams.button_color);
            }
            if (themeParams.button_text_color) {
                document.documentElement.style.setProperty('--button-text-color', themeParams.button_text_color);
            }
            
            trackEvent('theme_applied', {
                dark_mode: isDarkMode,
                theme_params: themeParams
            });
        }

        // Helper function to check if color is light
        function isLightColor(color) {
            if (!color) return false;
            
            // Convert hex to RGB
            const hex = color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5;
        }

        // Enhanced randomize function with analytics
        async function randomizeMovies() {
            trackEvent('randomize_initiated');
            
            // Show loading state
            showLoading('ai-recommendations');
            
            try {
                clearContainer('ai-recommendations');
                
                const genres = ['action', 'comedy', 'drama', 'sci-fi', 'thriller'];
                const randomGenre = genres[Math.floor(Math.random() * genres.length)];
                
                const randomMovies = await fetchRandomMovies(randomGenre);
                
                if (randomMovies.length === 0) {
                    document.getElementById('ai-recommendations').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-random"></i>
                            <h3>No Random Movies Found</h3>
                            <p>Try again in a moment.</p>
                        </div>
                    `;
                    trackEvent('randomize_no_results');
                } else {
                    document.getElementById('reason-text').textContent = "Here's a random selection of movies from different genres for you to discover something new!";
                    document.getElementById('ai-reason').style.display = 'block';
                    
                    randomMovies.forEach(movie => {
                        createCard(movie, 'ai-recommendations', false);
                    });
                    
                    document.getElementById('load-more-ai').style.display = 'flex';
                    
                    trackEvent('randomize_success', {
                        genre: randomGenre,
                        movie_count: randomMovies.length
                    });
                }
                
                provideHapticFeedback('success');
            } catch (error) {
                console.error('Randomization error:', error);
                document.getElementById('ai-recommendations').innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Randomization Error</h3>
                        <p>Unable to get random movies. Please try again later.</p>
                    </div>
                `;
                trackEvent('randomize_error', { error: error.message });
                provideHapticFeedback('error');
            }
        }

        // Enhanced share function with analytics
        function shareMovie(title, movieId = null) {
            const shareUrl = `${WEBSITE_URL}?search=${encodeURIComponent(title)}`;
            const shareText = `Check out "${title}" on Hosman Reviews! ðŸŽ¬\n\n${shareUrl}`;
            
            trackEvent('share_attempted', {
                movie_title: title,
                movie_id: movieId,
                share_method: 'telegram'
            });
            
            if (Telegram && Telegram.isVersionAtLeast('6.1')) {
                Telegram.showPopup({
                    title: 'Share Movie',
                    message: `Share "${title}" with friends?`,
                    buttons: [
                        {
                            type: 'default',
                            text: 'Copy Link',
                            id: 'copy'
                        },
                        {
                            type: 'default',
                            text: 'Share via Telegram',
                            id: 'telegram'
                        },
                        {
                            type: 'cancel',
                            id: 'cancel'
                        }
                    ]
                }, (buttonId) => {
                    if (buttonId === 'copy') {
                        copyToClipboard(shareUrl);
                        showTelegramAlert('Link copied to clipboard! ðŸ“‹');
                        trackEvent('share_completed', {
                            method: 'copy_link',
                            movie_title: title,
                            movie_id: movieId
                        });
                    } else if (buttonId === 'telegram' && Telegram.shareToChat) {
                        Telegram.shareToChat(shareText);
                        trackEvent('share_completed', {
                            method: 'telegram_chat',
                            movie_title: title,
                            movie_id: movieId
                        });
                    } else if (buttonId === 'telegram' && Telegram.openTelegramLink) {
                        Telegram.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(`Check out "${title}" ðŸŽ¬`)}`);
                        trackEvent('share_completed', {
                            method: 'telegram_link',
                            movie_title: title,
                            movie_id: movieId
                        });
                    }
                });
            } else {
                copyToClipboard(shareUrl);
                showNativeTooltip();
                trackEvent('share_completed', {
                    method: 'copy_link_fallback',
                    movie_title: title,
                    movie_id: movieId
                });
            }
            
            provideHapticFeedback('light');
        }

        // Enhanced modal open with analytics
        async function openModal(movieId, clickedElement = null) {
            try {
                provideHapticFeedback('light');
                document.getElementById('modal-ai-summary').innerHTML = '<p><div class="spinner"></div> Generating AI summary...</p>';
                
                trackEvent('movie_modal_opened', { movie_id: movieId });
                
                const item = await fetchMovieDetails(movieId);
                
                if (!item) {
                    showTelegramAlert('Error loading details. Please try again.');
                    trackEvent('movie_modal_error', { movie_id: movieId, error: 'fetch_failed' });
                    return;
                }
                
                currentMovieForShare = item;
                
                // Update modal content
                const title = item.title;
                const year = item.release_date ? item.release_date.substring(0, 4) : 'TBA';
                const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
                const runtime = item.runtime ? `${item.runtime} min` : 'TBA';
                const imagePath = item.poster_path ? `${TMDB_IMAGE_BASE_URL}${item.poster_path}` : PLACEHOLDER_IMAGE;
                
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-year').textContent = year;
                document.getElementById('modal-rating').textContent = `${rating}/10`;
                document.getElementById('modal-runtime').textContent = runtime;
                document.getElementById('modal-overview').textContent = item.overview || 'No overview available.';
                document.getElementById('modal-poster').src = imagePath;
                
                // Generate AI summary
                const aiSummary = await generateMovieSummary(title, item.overview || '');
                document.getElementById('modal-ai-summary').innerHTML = `<p>${aiSummary}</p>`;
                
                // Show modal
                const modal = document.getElementById('movie-modal');
                modal.style.display = 'block';
                
                setTimeout(() => {
                    modal.classList.add('show');
                }, 10);
                
                trackEvent('movie_modal_loaded', {
                    movie_id: movieId,
                    movie_title: title,
                    has_poster: !!item.poster_path,
                    has_summary: !!aiSummary
                });
                
            } catch (error) {
                console.error('Error opening modal:', error);
                showTelegramAlert('Error loading details. Please try again.');
                trackEvent('movie_modal_error', { 
                    movie_id: movieId, 
                    error: error.message 
                });
            }
        }

        // Enhanced AI recommendations with analytics
        async function performAIRecommendations(prompt, category = '', loadMore = false) {
            if (!loadMore) {
                showLoading('ai-recommendations');
                aiPage = 1;
                provideHapticFeedback('light');
                
                trackEvent('ai_recommendations_requested', {
                    prompt: prompt,
                    category: category,
                    is_load_more: false
                });
            } else {
                trackEvent('ai_recommendations_load_more', {
                    prompt: prompt,
                    category: category,
                    page: aiPage
                });
            }
            
            const searchButton = document.getElementById('generate-recommendations');
            const originalText = searchButton.innerHTML;
            searchButton.innerHTML = '<div class="spinner"></div> Searching...';
            searchButton.disabled = true;
            
            try {
                let movies = [];
                
                if (category) {
                    movies = await fetchMoviesByCategory(category, aiPage);
                    currentCategory = category;
                    currentSearchQuery = '';
                } else if (prompt) {
                    movies = await searchTMDBWithAI(prompt, aiPage);
                    currentSearchQuery = prompt;
                    currentCategory = '';
                } else {
                    const trending = await fetchTrendingMovies(aiPage);
                    movies = trending.slice(0, 6);
                    currentSearchQuery = '';
                    currentCategory = '';
                }
                
                if (!loadMore) {
                    clearContainer('ai-recommendations');
                }
                
                if (movies.length === 0) {
                    if (!loadMore) {
                        document.getElementById('ai-recommendations').innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <h3>No recommendations found</h3>
                                <p>Try a different description or category.</p>
                            </div>
                        `;
                    }
                    provideHapticFeedback('warning');
                    
                    trackEvent('ai_recommendations_no_results', {
                        prompt: prompt,
                        category: category
                    });
                } else {
                    if (!loadMore) {
                        const reasonText = generateAIReason(prompt, category);
                        document.getElementById('reason-text').textContent = reasonText;
                        document.getElementById('ai-reason').style.display = 'block';
                        provideHapticFeedback('success');
                    }
                    
                    movies.forEach(movie => {
                        createCard(movie, 'ai-recommendations', false);
                    });
                    
                    document.getElementById('load-more-ai').style.display = 'flex';
                    
                    trackEvent('ai_recommendations_success', {
                        prompt: prompt,
                        category: category,
                        results_count: movies.length,
                        is_load_more: loadMore
                    });
                }
            } catch (error) {
                console.error('AI recommendation error:', error);
                if (!loadMore) {
                    document.getElementById('ai-recommendations').innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Recommendation Error</h3>
                            <p>Unable to generate recommendations. Please try again later.</p>
                        </div>
                    `;
                }
                provideHapticFeedback('error');
                
                trackEvent('ai_recommendations_error', {
                    prompt: prompt,
                    category: category,
                    error: error.message
                });
            } finally {
                searchButton.innerHTML = originalText;
                searchButton.disabled = false;
            }
        }

        // Debug panel functions
        function updateDebugInfo(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
            }
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Enhanced initialization
        async function initializePage() {
            try {
                // Initialize year filter
                initYearFilter();
                
                // Initialize Telegram SDK
                initTelegramApp();
                
                // Fetch data from TMDB
                const trendingData = await fetchMoviesByYear(selectedYear);
                const upcomingData = await fetchUpcomingMovies();
                
                // Clear loading indicators and populate with real data
                const loadingContainers = document.querySelectorAll('.cards-container');
                loadingContainers.forEach(container => {
                    container.innerHTML = '';
                });
                
                if (trendingData.length > 0) {
                    trendingData.forEach(movie => {
                        createCard(movie, 'trending', true);
                    });
                    trackEvent('trending_loaded', { count: trendingData.length });
                }
                
                if (upcomingData.length > 0) {
                    upcomingData.forEach(movie => {
                        createCard(movie, 'upcoming-container', false);
                    });
                    trackEvent('upcoming_loaded', { count: upcomingData.length });
                }
                
                trackEvent('page_initialized');
                    
            } catch (error) {
                console.error('Initialization error:', error);
                document.querySelectorAll('.cards-container').forEach(container => {
                    container.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Unable to load content. Please check your connection and try again.</p>
                        </div>
                    `;
                });
                trackEvent('initialization_error', { error: error.message });
            }
        }

        // Enhanced event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with real TMDB data
            initializePage();
            
            // Debug panel toggle
            document.getElementById('debug-toggle').addEventListener('click', toggleDebugPanel);
            
            // AI recommendations
            document.getElementById('generate-recommendations').addEventListener('click', function() {
                const prompt = document.getElementById('ai-prompt-input').value.trim();
                if (prompt || currentCategory) {
                    performAIRecommendations(prompt, currentCategory);
                } else {
                    showTelegramAlert('Please enter a description or select a category');
                }
            });
            
            // Category buttons with analytics
            document.querySelectorAll('.category-btn').forEach(button => {
                button.addEventListener('click', function() {
                    provideHapticFeedback('selection');
                    
                    document.querySelectorAll('.category-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    currentCategory = this.getAttribute('data-category');
                    currentSearchQuery = '';
                    document.getElementById('ai-prompt-input').value = '';
                    
                    trackEvent('category_selected', { category: currentCategory });
                    performAIRecommendations('', currentCategory);
                });
            });
            
            // Info buttons
            document.getElementById('ai-info-btn').addEventListener('click', function() {
                trackEvent('info_opened', { section: 'ai_recommendations' });
                openInfoModal();
            });
            
            document.getElementById('trending-info-btn').addEventListener('click', function() {
                trackEvent('info_opened', { section: 'trending' });
                openInfoModal();
            });
            
            // Load more buttons with analytics
            document.getElementById('load-more-trending').addEventListener('click', function() {
                trackEvent('load_more_clicked', { section: 'trending', page: trendingPage + 1 });
                loadMoreTrending();
            });
            
            document.getElementById('load-more-ai').addEventListener('click', function() {
                trackEvent('load_more_clicked', { section: 'ai', page: aiPage + 1 });
                loadMoreAI();
            });
            
            // Modal close
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    trackEvent('modal_closed');
                    closeModal();
                });
            });
            
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    trackEvent('modal_closed_backdrop');
                    closeModal();
                }
            });

            // URL parameter handling
            const urlParams = new URLSearchParams(window.location.search);
            const searchParam = urlParams.get('search');
            if (searchParam) {
                document.getElementById('ai-prompt-input').value = searchParam;
                trackEvent('deep_link_activated', { search_query: searchParam });
                performAIRecommendations(searchParam);
            }

            // Enter key support
            document.getElementById('ai-prompt-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('generate-recommendations').click();
                }
            });

            // Track visibility changes
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    trackEvent('app_foreground');
                } else {
                    trackEvent('app_background');
                }
            });
        });

        // Keep all other existing functions (fetchFromTMDB, createCard, etc.) exactly as they were
        // ... (all the remaining existing JavaScript code) ...
    </script>
</body>
</html>